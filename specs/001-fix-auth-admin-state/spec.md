# Feature Specification: Стабильная авторизация и статусы админ-панели

**Feature Branch**: `001-fix-auth-admin-state`  
**Created**: 2026-02-26  
**Status**: Draft  
**Input**: User description: "1) Инференс падает с 403 Invalid or missing X-API-Key; 2) Все инференсы падают с 403; 3) При входе в Admin аккаунты снова pending; 4) ready должен появляться после успешного health-check; 5) При повторном входе API key пропадает; ключ должен задаваться приложением как константа и не вводиться пользователем"

## Clarifications

### Session 2026-02-26

- Q: Как именно авторизовать генерацию без ручного ввода ключа? → A: Выдавать клиенту короткоживущий токен сессии, постоянный секрет хранить только на сервере.
- Q: Какой должна быть политика статусов аккаунта после неуспешного health-check? → A: Сразу переводить аккаунт в `failed`; в `ready` возвращать только после следующего успешного health-check.
- Q: Какой срок жизни токена сессии для генерации принять по умолчанию? → A: 24 часа без продления.
- Q: Какой срок действия админ-сессии принять, чтобы ключ не пропадал при повторном входе? → A: Сохранять между перезаходами; истечение после 12 часов неактивности.
- Q: Что считать источником истины для статусов аккаунтов в Admin? → A: Источник истины только сервер; UI читает статусы с сервера и не переопределяет их локально.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Успешная генерация без ручного ключа (Priority: P1)

Как пользователь, я хочу запускать генерацию без ручного ввода ключа доступа, чтобы инференс не падал с 403 и был доступен сразу после открытия приложения.

**Why this priority**: Это основной путь продукта; при его отказе ценность приложения равна нулю.

**Independent Test**: Пользователь открывает приложение, запускает генерацию с валидным промптом и получает задачу в очереди без ошибки 403.

**Acceptance Scenarios**:

1. **Given** пользователь открыл приложение, **When** запускает генерацию, **Then** запрос принимается и задача создаётся без ошибки авторизации.
2. **Given** пользователь перезагрузил страницу, **When** снова запускает генерацию, **Then** поведение авторизации остаётся рабочим без ручного ввода ключа.

---

### User Story 2 - Достоверные статусы аккаунтов в Admin (Priority: P1)

Как администратор, я хочу видеть устойчивые статусы аккаунтов, чтобы понимать, какие воркеры действительно готовы к нагрузке.

**Why this priority**: Неверные статусы ломают маршрутизацию нагрузки и вводят оператора в заблуждение.

**Independent Test**: Администратор открывает панель, запускает проверку здоровья и видит, что успешно проверенный аккаунт получает статус `ready` и не откатывается в `pending` при повторном входе.

**Acceptance Scenarios**:

1. **Given** аккаунт прошёл health-check, **When** администратор обновляет страницу или снова заходит в панель, **Then** статус остаётся `ready`.
2. **Given** аккаунт ещё не проверен, **When** проверка ещё не выполнялась, **Then** он может иметь `pending`, но после успешной проверки меняется на `ready`.
3. **Given** аккаунт отправлен на проверку, **When** deploy/health-check выполняется, **Then** статус проходит `checking` и завершается в `ready` или `failed`.

---

### User Story 3 - Сохранение админ-доступа между сессиями (Priority: P2)

Как администратор, я хочу, чтобы ключ доступа в админ-панель не исчезал при повторном заходе, чтобы не терять время на повторный ввод и не блокировать операции.

**Why this priority**: Снижает операционные задержки и риск ручных ошибок при повторной авторизации.

**Independent Test**: Администратор входит в панель, закрывает и открывает страницу заново, после чего доступ и управляемость панели сохраняются по правилам сессии.

**Acceptance Scenarios**:

1. **Given** администратор уже авторизован, **When** повторно открывает панель в рамках допустимой сессии, **Then** доступ восстанавливается без потери ключа.

---

### Edge Cases

- Что происходит, если сохранённый ключ доступа стал недействительным: система должна явно запросить повторную авторизацию и показать понятную причину.
- Что происходит, если health-check временно недоступен: аккаунт должен переходить в `failed` и оставаться вне `ready` до следующей успешной проверки.
- Что происходит при одновременном обновлении панели и запуске проверок: итоговый статус должен отражать последнее подтверждённое состояние, а не промежуточный сброс.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST принимать запросы генерации от авторизованного клиента через короткоживущий токен сессии без обязательного ручного ввода ключа пользователем на главном экране.
- **FR-002**: Система MUST предотвращать массовые 403-ошибки в стандартном пользовательском сценарии запуска генерации.
- **FR-003**: Система MUST сохранять состояние админ-доступа между повторными заходами в пределах политики сессии.
- **FR-004**: Система MUST сохранять статусы аккаунтов между переходами в админ-панель и перезагрузками страницы.
- **FR-005**: Система MUST переводить аккаунт в статус `ready` только после успешного health-check.
- **FR-006**: Система MUST показывать пользователю/администратору понятное сообщение при отказе авторизации или недоступности проверки.
- **FR-007**: Постоянный сервисный ключ MUST храниться только на серверной стороне и никогда не передаваться в клиент в открытом виде.
- **FR-008**: Система MUST переводить аккаунт в статус `failed` при неуспешном health-check и не возвращать его в `ready` без последующего успешного health-check.
- **FR-009**: Токен клиентской сессии для генерации MUST иметь срок действия 24 часа и не продлеваться автоматически.
- **FR-010**: Админ-сессия MUST сохраняться между повторными входами и завершаться после 12 часов неактивности.
- **FR-011**: Статусы аккаунтов в Admin MUST определяться только сервером; клиент MUST отображать полученное серверное состояние без локального переопределения.
- **FR-012**: Ошибки авторизации и health-check MUST возвращать структурированный формат: `code`, `detail`, `user_action`.

### API Contract & Compatibility *(mandatory)*

- Контракт авторизации генерации должен оставаться совместимым с текущим пользовательским потоком без ручного ввода ключа на каждом запуске и использовать клиентский токен сессии сроком 24 часа без автоматического продления.
- Контракт статусов аккаунтов должен гарантировать, что после подтверждения работоспособности аккаунт возвращается как `ready` при повторном чтении состояния, а при неуспешной проверке отражается как `failed`.
- Изменения в сообщениях об ошибках должны быть обратимо совместимыми для текущих экранов генерации и админ-панели.
- Контракт чтения статусов аккаунтов должен быть сервер-авторитетным: клиент не формирует и не фиксирует собственные итоговые статусы аккаунтов.
- Ошибки `401/403/5xx` MUST содержать поля `code`, `detail`, `user_action`.

### Security & Secrets Impact *(mandatory)*

- Пользовательский интерфейс не должен требовать отображения постоянного сервисного ключа в явном виде, так как этот ключ хранится только на сервере.
- Доступ к административным операциям должен сохранять проверку прав даже при восстановлении сессии.
- Любое долговременное хранение ключа должно учитывать минимизацию утечек через интерфейс, логи и историю браузера.
- При истечении срока токена доступ к генерации должен требовать выдачи нового токена по штатному безопасному сценарию.
- При истечении 12 часов неактивности админ-сессия должна принудительно требовать повторную авторизацию.

### Observability & Operations *(mandatory)*

- Система должна фиксировать смену статусов аккаунтов с указанием предыдущего и нового состояния.
- Для отказов авторизации и health-check должны быть доступны диагностические сообщения, пригодные для быстрого разбора инцидента.
- Оператор должен видеть конечный статус проверки аккаунта без неоднозначных переходов `ready -> pending` при обычной навигации.

### Key Entities *(include if feature involves data)*

- **ClientSessionTokenState**: Состояние токена клиентской сессии (выдан, валиден, истёк, недействителен).
- **AdminAccountHealth**: Состояние аккаунта маршрутизации (pending, checking, ready, failed) и время последней успешной проверки.
- **GenerationAuthResult**: Результат авторизационной проверки для запуска генерации (разрешено/запрещено + причина отказа).

## Assumptions

- Допустимо использовать только серверное хранение постоянного сервисного ключа; клиент получает короткоживущий токен сессии для стандартного пользовательского сценария.
- Повторный вход в админ-панель в рамках активной сессии не требует повторного ручного ввода ключа.
- Активной считается сессия с простоями не более 12 часов.
- Переходы между экранами не считаются новым сеансом и не должны сбрасывать проверенные статусы аккаунтов.

## Dependencies

- Доступность сервиса проверки работоспособности аккаунтов, от которого зависит переход в `ready`.
- Наличие валидного сервисного ключа, выданного для пользовательского сценария генерации.
- Согласованное серверное состояние между экранами генерации и админ-панели в рамках одной пользовательской сессии.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Не менее 95% последовательных запусков генерации в smoke-сценарии завершаются без ошибки авторизации.
- **SC-002**: В 100% проверок после успешного health-check аккаунт отображается как `ready` при повторном открытии админ-панели.
- **SC-003**: В 100% повторных входов в админ-панель в пределах активной сессии доступ сохраняется без ручного повторного ввода ключа.
- **SC-004**: Для 100% авторизационных отказов и сбоев health-check пользователь или оператор получает понятную причину отказа.
